async function generarPreguntas() {
    const apiKey = document.getElementById('apiKey').value.trim();
    const videoUrl = document.getElementById('videoUrl').value.trim();
    const btn = document.getElementById('btnGenerar');
    const loader = document.getElementById('loader');
    const resultadoDiv = document.getElementById('resultado');

    if (!apiKey) { alert("Por favor, pega tu API Key."); return; }
    if (!videoUrl) { alert("Por favor, pega un link de YouTube."); return; }

    btn.disabled = true;
    loader.style.display = "block";
    resultadoDiv.innerHTML = "";

    // Prompt optimizado para que Gemini no se confunda
    const promptTexto = `Actúa como un experto en educación médica. Analiza el contenido de este video de YouTube: ${videoUrl}. 
    Crea un cuestionario de 10 preguntas de opción múltiple con 4 opciones cada una. 
    Al final de cada pregunta, escribe 'Respuesta correcta: [letra]'. 
    Formatea todo el contenido usando etiquetas HTML (h3 para preguntas y ul/li para opciones).`;

    try {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
        
        const response = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                contents: [{ parts: [{ text: promptTexto }] }]
            })
        });

        const data = await response.json();

        if (data.error) {
            throw new Error(`Código ${data.error.code}: ${data.error.message}`);
        }

        if (data.candidates && data.candidates[0].content) {
            let texto = data.candidates[0].content.parts[0].text;
            // Limpiamos posibles bloques de código que la IA a veces agrega
            texto = texto.replace(/```html|```/g, "");
            resultadoDiv.innerHTML = texto;
        } else {
            resultadoDiv.innerHTML = "La IA no pudo procesar este video. Intenta con otro link.";
        }
        
    } catch (error) {
        resultadoDiv.innerHTML = `<div style="border:2px solid red; padding:15px; color:red;">
            <strong>ERROR DETECTADO:</strong><br>
            ${error.message} <br><br>
            <em>Tip: Si dice '403', tu clave ya no sirve. Genera una nueva y NO la subas al código de GitHub.</em>
        </div>`;
    } finally {
        btn.disabled = false;
        loader.style.display = "none";
    }
}
